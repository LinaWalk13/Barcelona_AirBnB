---
title: "preprocessing"
author: "Lina Walkowiak"
date: "2025-05-02"
output: html_document
---

### Datasets overview

| File Name                              | Year(s) | Description                                              | Use in Analysis                                     |
|----------------------------------------|---------|----------------------------------------------------------|-----------------------------------------------------|
| `2015_disposable_income.csv`           | 2015    | Disposable income per person                             | Baseline income level                               |
| `2021_disposable_income.csv`           | 2021    | Disposable income per person                             | Later income level → compute Δincome                |
| `2015_population_edu_sex.csv`          | 2015    | Education level and sex composition                      | Baseline education structure                        |
| `2024_16_over_education_sex.csv`       | 2024    | Education (age 16+) by sex                               | Compare with 2015 → compute Δeducation              |
| `2015_Number_size_cadastral_value.csv` | 2015    | Number, size, and cadastral value of housing units       | Baseline housing stock and value                    |
| `2025_Number_size_cadastral_value.csv` | 2025    | Same as above                                            | Compare with 2015 → compute Δhousing units or value |
| `2018_ownership_cadastral.csv`         | 2018    | Cadastral value by owner type (e.g., private, corporate) | Intermediate ownership baseline                     |
| `2025_ownership_cadastral.csv`         | 2025    | Updated cadastral ownership info                         | Compare with 2018 → compute Δownership patterns     |

---
## Socio-Economic Datasets

To investigate the socio-spatial impacts of Airbnb in Barcelona, we integrate several socio-economic datasets at the **census section (Secció Censal)** level. These datasets capture changes in income, education, housing structure, and ownership between 2015 and 2025 (or what years data is available for closest to these years). 

### Disposable income  
- Proxy for neighborhood affluence. Rising income levels may indicate socio-economic upgrading, displacement of lower-income residents, or gentrification.
- Compare income between 2015 and 2021 to compute `delta_income = income_2021 − income_2015` per census section. Test whether has risen more in areas with high Airbnb presence in 2015.

### Education level  
- Proxy for social class and educational stratification. Increasing share of tertiary-educated residents may signal higher-class influx.
- Calculate change in the proportion of tertiary education from 2015 to 2024. Use as `delta_education` to compare educational shifts across high/low airbnb areas.

### Housing units and value  

- Indicates real estate dynamics. Rising housing unit counts or cadastral values may reflect real estate investment, tourism-related conversions, or housing pressure.
- Compute `delta_units` and `delta_cadastral_value` to quantify shifts in the housing stock and value.
---

### Ownership structure

-   Shifts from local/private ownership to corporate or foreign ownership may reflect the commodification of residential real estate.
-   Calculate `delta_foreign_ownership` or `delta_corporate_ownership`. Assess whether Airbnb areas became more investor-driven compared to control areas.

------------------------------------------------------------------------

### Resulting change variables

-   `delta_income = income_2021 − income_2015`
-   `delta_units = housing_units_2025 − housing_units_2015`
-   `delta_cadastral_value = cadastral_2025 − cadastral_2015`
-   `delta_foreign_ownership = % foreign_2025 − % foreign_2018`
-   `delta_education = % tertiary_2024 − % tertiary_2015`

These variables can be used to evaluate whether **treatment areas** (with high airbnb density in 2015) experienced **greater socio-economic change** than **control areas**.

### Combining with airbnb data

Each dataset is matched by `Seccio_Censal` and merged with listing data from 2015. This enables: - Comparisons (statistical method to be decided) - Mapping or visualization, maybe also identifying clusters??

```{r}
# Load packages
library(dplyr)
library(lubridate)
library(readr)

# Read data
listings <- read_csv("../data/listings.csv")

# Parse dates to get year information
listings <- listings %>%
  select(id, 
         host_id, 
         host_neighbourhood, 
         neighbourhood_cleansed,
         first_review, 
         latitude, 
         host_listings_count,
         longitude, 
         property_type, 
         room_type, 
         price
         ) 
listings <- listings %>%
   mutate(first_review = as.Date(first_review, format = "%d.%m.%y"))

# create presence flag for 2015
listings <- listings %>%
  mutate(in_2015 = if_else(!is.na(first_review) & first_review <= as.Date("2015-12-31"), 1, 0))

listings2015 <- listings %>%
  filter(in_2015 == 1)
```

## Spatial visualisation

```{r}
library(sf)     
library(ggplot2) 

# Convert to sf object using longitude and latitude columns form data 
airbnb_sf <- st_as_sf(listings, 
                      coords = c("longitude", "latitude"), 
                      crs = 4326)  # WGS 84 – standard lat/lon

airbnb_2015 <- st_as_sf(listings2015, 
                      coords = c("longitude", "latitude"), 
                      crs = 4326) 

###### BOUNDARIES

secCens <- st_read("../data/BCN_UNITATS_ADM/0301040100_SecCens_UNITATS_ADM.shp")

# info
plot(secCens$geometry)
head(secCens)
st_crs(secCens)

# Transform to match CRS
secCens_4326 <- st_transform(secCens, crs = 4326)
names(secCens_4326)

```
